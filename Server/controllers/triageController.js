// Updated: 2025-12-19 12:28:09 - style(validation): implement patient form in validation (fixes #36)
// Updated: 2025-12-19 12:27:54 - fix(triage): add triage system in triage
// Updated: 2025-12-19 12:27:43 - perf(triage): add triage triage system
// Updated: 2025-12-19 12:27:15 - chore(socket): add database schema
// Updated: 2025-12-19 12:27:03 - perf(patient): update error handling
// Updated: 2025-12-19 12:27:01 - fix(socket): refactor UI components in socket
// Updated: 2025-12-19 12:26:55 - test(database): enhance dashboard
// Updated: 2025-12-19 12:26:34 - refactor(triage): fix triage dashboard
// Updated: 2025-12-19 12:26:30 - fix(database): enhance UI components
// Updated: 2025-12-19 12:26:10 - test(auth): update triage system in auth
// Updated: 2025-12-19 12:25:27 - chore(validation): improve UI components in validation
// Updated: 2025-12-19 12:25:24 - feat: implement ui database schema
// Updated: 2025-12-19 12:25:18 - style: update socket error handling
// Updated: 2025-12-19 12:25:06 - test(auth): optimize database schema
// Updated: 2025-12-19 12:25:05 - test: fix patient API endpoints
// Updated: 2025-12-19 12:23:16 - style: update patient patient form (fixes #39)
// Updated: 2025-12-19 12:23:14 - refactor: implement triage error handling
// Updated: 2025-12-19 12:23:05 - style(patient): implement database schema
// Updated: 2025-12-19 12:23:04 - style(triage): refactor triage patient form
// Updated: 2025-12-19 12:22:50 - style: implement database database schema
// Updated: 2025-12-19 12:22:40 - docs: fix ui API endpoints
// Updated: 2025-12-19 12:22:34 - style(patient): refactor dashboard
// Updated: 2025-12-19 12:22:16 - perf(triage): add API endpoints in triage
// Updated: 2025-12-19 12:22:08 - style(socket): improve dashboard
// Updated: 2025-12-19 12:22:07 - test(socket): improve socket triage system (fixes #32)
// Updated: 2025-12-19 12:22:02 - docs(auth): enhance auth triage system
// Updated: 2025-12-19 12:21:50 - feat(triage): implement triage error handling
// Updated: 2025-12-19 12:21:40 - perf(auth): update database schema (fixes #12)
// Updated: 2025-12-19 12:21:39 - perf(validation): refactor error handling in validation
// Updated: 2025-12-19 12:21:20 - refactor(patient): add error handling
// Updated: 2025-12-19 12:21:19 - style(validation): update database schema in validation
// Updated: 2025-12-19 12:21:14 - feat: enhance socket UI components (fixes #16)
// Updated: 2025-12-19 12:21:12 - refactor: enhance triage UI components
// Updated: 2025-12-19 12:21:08 - docs(patient): implement database schema
// Updated: 2025-12-19 12:21:03 - chore: improve socket UI components (fixes #20)
// Updated: 2025-12-19 12:20:57 - refactor: update ui patient form
// Updated: 2025-12-19 12:20:53 - test(patient): implement patient API endpoints (fixes #4)
// Updated: 2025-12-19 12:20:48 - fix(socket): refactor triage system
// Updated: 2025-12-19 12:20:42 - chore(validation): update validation API endpoints
// Updated: 2025-12-19 12:20:31 - style(socket): fix socket API endpoints
// Updated: 2025-12-19 12:20:29 - test(auth): improve auth UI components
// Updated: 2025-12-19 12:20:22 - docs(database): enhance database UI components (fixes #9)
// Updated: 2025-12-19 12:20:20 - fix(validation): refactor API endpoints
// Updated: 2025-12-19 12:20:09 - perf(triage): update dashboard in triage
// Updated: 2025-12-19 12:20:00 - feat(api): update api database schema
// Updated: 2025-12-19 12:19:50 - fix(ui): optimize database schema (fixes #15)
// Updated: 2025-12-19 12:19:37 - docs(api): add UI components in api
// Updated: 2025-12-19 12:19:36 - test(ui): implement error handling in ui
// Updated: 2025-12-19 12:19:27 - chore: refactor triage UI components
// Updated: 2025-12-19 12:19:18 - chore(patient): improve database schema
// Updated: 2025-12-19 12:19:11 - docs(database): refactor database authentication (fixes #2)
// Updated: 2025-12-19 12:19:08 - docs: update patient authentication
// Updated: 2025-12-19 12:19:08 - chore(triage): add API endpoints (fixes #10)
// Updated: 2025-12-19 12:18:24 - fix: add ui triage system (fixes #35)
// Updated: 2025-12-19 12:18:20 - refactor(ui): enhance API endpoints in ui
// Updated: 2025-12-19 12:18:18 - feat(auth): enhance auth API endpoints (fixes #5)
// Updated: 2025-12-19 12:18:15 - fix: update ui API endpoints (fixes #10)
// Updated: 2025-12-19 12:18:09 - chore(validation): add UI components
// Updated: 2025-12-19 12:18:07 - chore(auth): improve authentication
// Updated: 2025-12-19 12:17:43 - fix(patient): enhance patient form
// Updated: 2025-12-19 12:17:40 - refactor: add api error handling
// Updated: 2025-12-19 12:07:45 - style(database): add database API endpoints
// Updated: 2025-12-19 12:07:32 - style(socket): update UI components (fixes #6)
// Updated: 2025-12-19 12:07:02 - refactor(triage): fix triage error handling (fixes #44)
// Updated: 2025-12-19 12:06:37 - perf: refactor ui API endpoints
// Updated: 2025-12-19 12:06:32 - perf(validation): add error handling in validation
// Updated: 2025-12-19 12:06:31 - refactor: optimize api patient form
// Updated: 2025-12-19 12:06:26 - chore: implement patient triage system
// Updated: 2025-12-19 12:06:11 - docs(validation): update validation dashboard
// Updated: 2025-12-19 12:06:09 - feat(api): enhance api database schema
// Updated: 2025-12-19 12:06:09 - chore: fix database triage system
// Updated: 2025-12-19 12:06:04 - test: add database triage system
// Updated: 2025-12-19 12:06:02 - fix(triage): implement triage system in triage
// Updated: 2025-12-19 12:05:50 - test: add triage database schema
// Updated: 2025-12-19 12:05:45 - style(patient): enhance database schema in patient
// Updated: 2025-12-19 12:05:35 - fix(database): update UI components
// Updated: 2025-12-19 12:05:35 - refactor(database): fix database patient form
// Updated: 2025-12-19 12:05:08 - fix: update api database schema (fixes #42)
// Updated: 2025-12-19 12:04:59 - feat(patient): add patient API endpoints
// Updated: 2025-12-19 12:04:50 - test(patient): fix patient triage system
// Updated: 2025-12-19 12:04:46 - perf(database): update database database schema
// Updated: 2025-12-19 12:04:38 - fix: enhance patient patient form
// Updated: 2025-12-19 12:04:17 - feat: refactor ui authentication
// Updated: 2025-12-19 12:04:06 - style(database): implement triage system in database
// Updated: 2025-12-19 12:03:30 - test(patient): improve triage system
import Patient from '../models/Patient.js';

// Mock diagnosis logic based on symptoms
const getDiagnosis = (symptoms) => {
  // Convert symptoms to lowercase for easier matching
  const lowerSymptoms = symptoms.map(symptom => symptom.toLowerCase());
  
  // Complex diagnosis patterns (check these first)
  if (lowerSymptoms.includes('chest pain') && lowerSymptoms.includes('shortness of breath')) {
    return 'Possible Heart Condition - Seek immediate medical attention';
  }
  
  if (lowerSymptoms.includes('severe headache') && lowerSymptoms.includes('neck stiffness')) {
    return 'Possible Meningitis - Seek immediate medical attention';
  }
  
  if (lowerSymptoms.includes('fever') && lowerSymptoms.includes('cough') && lowerSymptoms.includes('fatigue')) {
    return 'Possible Flu - Rest and stay hydrated';
  }
  
  if (lowerSymptoms.includes('fever') && lowerSymptoms.includes('sore throat') && lowerSymptoms.includes('swollen glands')) {
    return 'Possible Strep Throat - Consider antibiotic treatment';
  }
  
  if (lowerSymptoms.includes('runny nose') && lowerSymptoms.includes('sneezing') && lowerSymptoms.includes('cough')) {
    return 'Common Cold - Rest and fluids recommended';
  }
  
  if (lowerSymptoms.includes('nausea') && lowerSymptoms.includes('vomiting') && lowerSymptoms.includes('diarrhea')) {
    return 'Gastroenteritis - Stay hydrated and rest';
  }
  
  if (lowerSymptoms.includes('headache') && lowerSymptoms.includes('muscle aches') && lowerSymptoms.includes('fatigue')) {
    return 'Possible Viral Infection - Rest and monitor symptoms';
  }
  
  // Single symptom patterns
  if (lowerSymptoms.includes('fever')) {
    return 'Fever - Monitor temperature and stay hydrated';
  }
  
  if (lowerSymptoms.includes('headache')) {
    return 'Headache - Rest and consider over-the-counter pain relief';
  }
  
  if (lowerSymptoms.includes('cough')) {
    return 'Cough - Stay hydrated and rest';
  }
  
  if (lowerSymptoms.includes('sore throat')) {
    return 'Sore Throat - Gargle with warm salt water';
  }
  
  if (lowerSymptoms.includes('fatigue')) {
    return 'Fatigue - Ensure adequate rest and nutrition';
  }
  
  if (lowerSymptoms.includes('chest pain')) {
    return 'Chest Pain - Seek medical attention promptly';
  }
  
  if (lowerSymptoms.includes('shortness of breath')) {
    return 'Breathing Difficulty - Seek medical attention';
  }
  
  if (lowerSymptoms.includes('abdominal pain')) {
    return 'Abdominal Pain - Monitor and consider medical evaluation';
  }
  
  // Default diagnosis
  return 'General Symptoms - Consider consulting a healthcare provider for proper evaluation';
};

// @desc    Analyze symptoms and provide diagnosis
// @route   POST /api/triage/analyze
// @access  Private
const analyzeSymptoms = async (req, res) => {
  try {
    const { symptoms } = req.body;
    
    // Validate input
    if (!symptoms || !Array.isArray(symptoms) || symptoms.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Please provide a valid symptoms array',
      });
    }
    
    // Extract symptom names if they're objects
    const symptomNames = symptoms.map(symptom => 
      typeof symptom === 'object' ? symptom.name : symptom
    ).filter(name => typeof name === 'string' && name.trim().length > 0);
    
    if (symptomNames.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Please provide at least one valid symptom',
      });
    }
    
    // Get diagnosis using mock logic
    const diagnosis = getDiagnosis(symptomNames);
    
    // Save to database
    const patientRecord = await Patient.create({
      user: req.user.id,
      symptoms: symptoms, // Save the original symptom objects
      diagnosis,
      date: new Date(),
    });
    
    // Transform the response to match frontend expectations
    const response = {
      _id: patientRecord._id,
      symptoms: symptoms,
      priority: getPriorityFromDiagnosis(diagnosis),
      recommendation: {
        message: diagnosis
      },
      createdAt: patientRecord.date
    };
    
    res.status(201).json(response);
    
  } catch (error) {
    console.error('Analyze symptoms error:', error);
    res.status(500).json({
      success: false,
      message: 'Server error during symptom analysis',
    });
  }
};

// @desc    Get triage history for logged-in user
// @route   GET /api/triage/history
// @access  Private
const getTriageHistory = async (req, res) => {
  try {
    // Get all triage records for the logged-in user, sorted by date (newest first)
    const triageHistory = await Patient.find({ user: req.user.id })
      .sort({ date: -1 })
      .select('symptoms diagnosis date createdAt');
    
    res.status(200).json({
      success: true,
      message: 'Triage history retrieved successfully',
      data: {
        history: triageHistory,
        count: triageHistory.length,
      },
    });
    
  } catch (error) {
    console.error('Get triage history error:', error);
    res.status(500).json({
      success: false,
      message: 'Server error while retrieving triage history',
    });
  }
};

// @desc    Get single triage result by ID
// @route   GET /api/triage/results/:id
// @access  Private
const getTriageResult = async (req, res) => {
  try {
    const result = await Patient.findOne({
      _id: req.params.id,
      user: req.user.id
    });

    if (!result) {
      return res.status(404).json({
        success: false,
        message: 'Triage result not found'
      });
    }

    // Transform the data to match frontend expectations
    const response = {
      _id: result._id,
      symptoms: result.symptoms,
      priority: getPriorityFromDiagnosis(result.diagnosis),
      recommendation: {
        message: result.diagnosis
      },
      createdAt: result.date || result.createdAt
    };

    res.status(200).json(response);
    
  } catch (error) {
    console.error('Get triage result error:', error);
    res.status(500).json({
      success: false,
      message: 'Server error while retrieving triage result'
    });
  }
};

// Helper function to determine priority from diagnosis
const getPriorityFromDiagnosis = (diagnosis) => {
  const lowercaseDiagnosis = diagnosis.toLowerCase();
  if (lowercaseDiagnosis.includes('immediate') || 
      lowercaseDiagnosis.includes('emergency') || 
      lowercaseDiagnosis.includes('seek medical attention promptly')) {
    return 'High';
  }
  if (lowercaseDiagnosis.includes('consider medical') || 
      lowercaseDiagnosis.includes('monitor')) {
    return 'Medium';
  }
  return 'Low';
};

export { analyzeSymptoms, getTriageHistory, getTriageResult };




















































































