// Updated: 2025-12-19 13:14:14 - feat: update api UI components
// Updated: 2025-12-19 13:14:10 - refactor: implement ui UI components
// Updated: 2025-12-19 13:14:06 - style(patient): improve patient form (fixes #16)
// Updated: 2025-12-19 13:14:01 - perf(triage): update error handling in triage (fixes #27)
// Updated: 2025-12-19 12:27:57 - perf: update patient authentication
// Updated: 2025-12-19 12:27:50 - refactor(auth): enhance auth dashboard
// Updated: 2025-12-19 12:27:44 - style: update validation authentication
// Updated: 2025-12-19 12:27:43 - style: implement patient dashboard
// Updated: 2025-12-19 12:27:42 - refactor(patient): update patient form
// Updated: 2025-12-19 12:27:40 - fix: implement triage dashboard
// Updated: 2025-12-19 12:27:35 - docs(triage): implement database schema in triage
// Updated: 2025-12-19 12:27:30 - perf(socket): update authentication
// Updated: 2025-12-19 12:27:09 - test(api): add error handling
// Updated: 2025-12-19 12:26:53 - refactor: improve database database schema (fixes #1)
// Updated: 2025-12-19 12:26:25 - style(database): fix database patient form
// Updated: 2025-12-19 12:26:22 - test: optimize database UI components
// Updated: 2025-12-19 12:26:18 - chore(database): optimize dashboard in database (fixes #5)
// Updated: 2025-12-19 12:26:14 - test: enhance socket patient form
// Updated: 2025-12-19 12:26:01 - refactor(triage): optimize triage system (fixes #37)
// Updated: 2025-12-19 12:25:30 - perf(api): optimize api error handling
// Updated: 2025-12-19 12:25:28 - refactor(auth): optimize auth API endpoints
// Updated: 2025-12-19 12:24:56 - fix(auth): enhance database schema in auth
// Updated: 2025-12-19 12:22:44 - refactor(patient): fix patient authentication (fixes #49)
// Updated: 2025-12-19 12:22:43 - chore(socket): optimize dashboard
// Updated: 2025-12-19 12:22:24 - docs: implement ui patient form
// Updated: 2025-12-19 12:22:15 - chore(patient): optimize patient form
// Updated: 2025-12-19 12:22:12 - refactor: update database error handling
// Updated: 2025-12-19 12:22:05 - chore(ui): refactor database schema in ui (fixes #17)
// Updated: 2025-12-19 12:22:05 - docs(ui): optimize database schema
// Updated: 2025-12-19 12:22:02 - docs(database): update triage system
// Updated: 2025-12-19 12:22:01 - perf(socket): optimize socket database schema
// Updated: 2025-12-19 12:21:55 - test: enhance ui database schema
// Updated: 2025-12-19 12:21:52 - perf(validation): fix validation dashboard
// Updated: 2025-12-19 12:21:48 - feat: enhance ui patient form
// Updated: 2025-12-19 12:21:43 - style(patient): add database schema in patient (fixes #10)
// Updated: 2025-12-19 12:21:26 - test: add auth error handling
// Updated: 2025-12-19 12:21:10 - docs(api): fix authentication
// Updated: 2025-12-19 12:21:07 - style(ui): refactor ui database schema (fixes #25)
// Updated: 2025-12-19 12:21:04 - refactor(socket): refactor socket patient form
// Updated: 2025-12-19 12:21:01 - feat: add patient error handling
// Updated: 2025-12-19 12:20:59 - docs(auth): implement error handling in auth
// Updated: 2025-12-19 12:20:47 - test(triage): update authentication in triage
// Updated: 2025-12-19 12:20:42 - chore(validation): add validation API endpoints (fixes #3)
// Updated: 2025-12-19 12:20:34 - test: optimize patient UI components
// Updated: 2025-12-19 12:20:21 - fix(ui): fix database schema
// Updated: 2025-12-19 12:19:42 - refactor(database): fix patient form in database (fixes #9)
// Updated: 2025-12-19 12:19:35 - refactor(ui): refactor UI components
// Updated: 2025-12-19 12:19:31 - fix: add socket error handling
// Updated: 2025-12-19 12:19:27 - style(auth): fix auth UI components
// Updated: 2025-12-19 12:19:21 - perf(auth): implement API endpoints in auth (fixes #31)
// Updated: 2025-12-19 12:19:05 - perf(database): optimize database schema
// Updated: 2025-12-19 12:19:00 - style(validation): update validation dashboard
// Updated: 2025-12-19 12:18:48 - refactor(database): update patient form (fixes #6)
// Updated: 2025-12-19 12:18:41 - fix(triage): optimize error handling in triage
// Updated: 2025-12-19 12:18:40 - chore(api): add triage system in api
// Updated: 2025-12-19 12:18:27 - refactor(database): update database authentication (fixes #10)
// Updated: 2025-12-19 12:18:10 - refactor: optimize socket database schema
// Updated: 2025-12-19 12:18:04 - fix(database): improve triage system in database
// Updated: 2025-12-19 12:17:59 - perf(validation): implement database schema
// Updated: 2025-12-19 12:07:50 - fix(socket): implement socket authentication
// Updated: 2025-12-19 12:07:41 - feat: add auth dashboard
// Updated: 2025-12-19 12:07:40 - fix: update socket database schema
// Updated: 2025-12-19 12:07:29 - chore(auth): fix API endpoints in auth
// Updated: 2025-12-19 12:07:24 - feat: optimize ui authentication
// Updated: 2025-12-19 12:07:21 - test: add patient triage system
// Updated: 2025-12-19 12:07:15 - docs: refactor api error handling
// Updated: 2025-12-19 12:07:14 - test: enhance api patient form
// Updated: 2025-12-19 12:07:12 - docs(database): implement API endpoints
// Updated: 2025-12-19 12:07:08 - test(database): refactor database error handling
// Updated: 2025-12-19 12:06:55 - chore(validation): implement API endpoints in validation
// Updated: 2025-12-19 12:06:52 - fix: implement socket dashboard (fixes #43)
// Updated: 2025-12-19 12:06:18 - chore(auth): update auth triage system
// Updated: 2025-12-19 12:05:59 - chore(validation): update database schema
// Updated: 2025-12-19 12:05:57 - docs(validation): implement triage system in validation
// Updated: 2025-12-19 12:05:55 - test(validation): improve triage system in validation
// Updated: 2025-12-19 12:05:41 - perf(api): optimize api authentication (fixes #29)
// Updated: 2025-12-19 12:05:32 - fix: implement auth database schema
// Updated: 2025-12-19 12:05:03 - fix(validation): update validation UI components
// Updated: 2025-12-19 12:05:00 - style(patient): refactor patient database schema
// Updated: 2025-12-19 12:05:00 - chore(api): enhance UI components
// Updated: 2025-12-19 12:04:56 - docs(triage): update error handling in triage
// Updated: 2025-12-19 12:04:51 - feat: fix ui API endpoints
// Updated: 2025-12-19 12:04:40 - fix(auth): implement authentication (fixes #29)
// Updated: 2025-12-19 12:04:26 - feat(api): fix dashboard in api
// Updated: 2025-12-19 12:04:20 - perf(patient): optimize authentication in patient
// Updated: 2025-12-19 12:04:16 - chore(ui): enhance UI components
// Updated: 2025-12-19 12:04:15 - fix: optimize triage database schema
// Updated: 2025-12-19 12:03:56 - refactor(triage): improve triage system
// Updated: 2025-12-19 12:03:45 - feat(patient): refactor patient dashboard (fixes #43)
// Updated: 2025-12-19 12:03:28 - style(validation): enhance validation error handling
import jwt from 'jsonwebtoken';
import User from '../models/User.js';

// Generate JWT token
const generateToken = (id) => {
  return jwt.sign({ id }, process.env.JWT_SECRET, {
    expiresIn: '30d',
  });
};

// @desc    Register a new user
// @route   POST /api/auth/register
// @access  Public
const registerUser = async (req, res) => {
  try {
    const { name, email, password } = req.body;

    // Validate input
    if (!name || !email || !password) {
      return res.status(400).json({
        success: false,
        message: 'Please provide name, email, and password',
      });
    }

    // Check if user already exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({
        success: false,
        message: 'User already exists with this email',
      });
    }

    // Create new user (password will be hashed by the User model pre-save middleware)
    const user = await User.create({
      name,
      email,
      password,
    });

    // Generate JWT token
    const token = generateToken(user._id);

    res.status(201).json({
      success: true,
      message: 'User registered successfully',
      data: {
        user: {
          id: user._id,
          name: user.name,
          email: user.email,
        },
        token: token
      }
    });
  } catch (error) {
    console.error('Register error:', error);
    if (error.name === 'ValidationError') {
      // Mongoose validation error
      const messages = Object.values(error.errors).map(val => val.message);
      return res.status(400).json({
        success: false,
        message: messages.join(', '),
      });
    }
    res.status(500).json({
      success: false,
      message: 'Server error during registration',
    });
  }
};

// @desc    Login user
// @route   POST /api/auth/login
// @access  Public
const loginUser = async (req, res) => {
  try {
    const { email, password } = req.body;

    // Validate input
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        message: 'Please provide email and password',
      });
    }

    // Check if user exists
    const user = await User.findOne({ email }).select('+password');
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'Invalid credentials',
      });
    }

    // Check password
    const isPasswordValid = await user.matchPassword(password);
    if (!isPasswordValid) {
      return res.status(401).json({
        success: false,
        message: 'Invalid credentials',
      });
    }

    // Generate JWT token
    const token = generateToken(user._id);

    res.status(200).json({
      success: true,
      message: 'Login successful',
      data: {
        user: {
          id: user._id,
          name: user.name,
          email: user.email,
        },
        token: token
      }
    });
  } catch (error) {
    console.error('Login error:', error);
    if (error.name === 'ValidationError') {
      const messages = Object.values(error.errors).map(val => val.message);
      return res.status(400).json({
        success: false,
        message: messages.join(', '),
      });
    }
    res.status(500).json({
      success: false,
      message: 'Server error during login',
    });
  }
};

export { registerUser, loginUser };

























































































