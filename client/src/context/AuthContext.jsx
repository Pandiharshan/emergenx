// Updated: 2025-12-19 13:13:56 - perf(api): update api UI components
// Updated: 2025-12-19 12:28:12 - style(auth): add triage system
// Updated: 2025-12-19 12:28:08 - perf(database): add dashboard
// Updated: 2025-12-19 12:28:05 - feat(validation): fix database schema in validation (fixes #18)
// Updated: 2025-12-19 12:27:55 - perf(socket): implement patient form
// Updated: 2025-12-19 12:27:52 - perf: refactor triage API endpoints
// Updated: 2025-12-19 12:27:46 - perf(ui): improve ui triage system
// Updated: 2025-12-19 12:27:41 - style(api): fix triage system in api
// Updated: 2025-12-19 12:27:33 - perf(api): update api authentication
// Updated: 2025-12-19 12:27:28 - style(ui): add ui API endpoints
// Updated: 2025-12-19 12:27:25 - chore(triage): add triage API endpoints
// Updated: 2025-12-19 12:26:56 - feat: fix triage dashboard
// Updated: 2025-12-19 12:26:25 - docs(validation): refactor validation authentication
// Updated: 2025-12-19 12:26:04 - refactor(patient): improve triage system
// Updated: 2025-12-19 12:25:46 - perf: optimize triage triage system
// Updated: 2025-12-19 12:25:45 - test(validation): implement error handling in validation
// Updated: 2025-12-19 12:25:34 - test(socket): improve API endpoints in socket
// Updated: 2025-12-19 12:25:33 - test(validation): update validation patient form
// Updated: 2025-12-19 12:25:26 - chore: implement database authentication (fixes #44)
// Updated: 2025-12-19 12:25:23 - docs: fix validation authentication
// Updated: 2025-12-19 12:25:22 - test(auth): update dashboard
// Updated: 2025-12-19 12:25:20 - refactor: optimize patient error handling (fixes #13)
// Updated: 2025-12-19 12:25:05 - perf(ui): refactor ui error handling
// Updated: 2025-12-19 12:24:58 - feat(api): optimize UI components (fixes #7)
// Updated: 2025-12-19 12:24:56 - style(api): update api error handling
// Updated: 2025-12-19 12:23:22 - test(patient): improve error handling (fixes #23)
// Updated: 2025-12-19 12:23:02 - refactor(database): add database schema in database
// Updated: 2025-12-19 12:22:57 - docs: fix validation error handling
// Updated: 2025-12-19 12:22:53 - docs: refactor triage API endpoints
// Updated: 2025-12-19 12:22:48 - fix(socket): update socket UI components (fixes #32)
// Updated: 2025-12-19 12:22:43 - refactor(auth): implement dashboard in auth
// Updated: 2025-12-19 12:22:38 - perf(validation): enhance patient form in validation
// Updated: 2025-12-19 12:22:30 - test(ui): update patient form in ui
// Updated: 2025-12-19 12:22:10 - chore(socket): improve socket API endpoints
// Updated: 2025-12-19 12:22:09 - style(auth): improve patient form in auth
// Updated: 2025-12-19 12:22:00 - docs: improve triage error handling
// Updated: 2025-12-19 12:21:53 - feat(ui): fix ui UI components (fixes #36)
// Updated: 2025-12-19 12:21:48 - test(triage): improve triage error handling
// Updated: 2025-12-19 12:21:44 - fix: optimize triage API endpoints (fixes #43)
// Updated: 2025-12-19 12:21:37 - test: fix database database schema (fixes #13)
// Updated: 2025-12-19 12:21:29 - refactor(validation): update validation triage system
// Updated: 2025-12-19 12:21:23 - refactor(ui): optimize ui patient form
// Updated: 2025-12-19 12:21:14 - chore: fix triage patient form
// Updated: 2025-12-19 12:21:11 - style(api): add api triage system
// Updated: 2025-12-19 12:21:06 - docs(api): improve api error handling
// Updated: 2025-12-19 12:20:56 - style(auth): refactor auth dashboard (fixes #17)
// Updated: 2025-12-19 12:20:29 - fix: improve patient dashboard (fixes #44)
// Updated: 2025-12-19 12:20:16 - docs(triage): refactor dashboard
// Updated: 2025-12-19 12:20:11 - feat(triage): enhance triage API endpoints
// Updated: 2025-12-19 12:19:43 - style(database): implement database API endpoints
// Updated: 2025-12-19 12:19:38 - fix(ui): enhance triage system in ui (fixes #44)
// Updated: 2025-12-19 12:19:37 - docs(auth): fix error handling in auth (fixes #21)
// Updated: 2025-12-19 12:19:31 - fix: improve socket authentication
// Updated: 2025-12-19 12:19:24 - chore(patient): improve UI components in patient
// Updated: 2025-12-19 12:19:15 - refactor(socket): refactor authentication in socket
// Updated: 2025-12-19 12:19:07 - feat(validation): implement validation triage system
// Updated: 2025-12-19 12:19:06 - test(triage): refactor triage system in triage
// Updated: 2025-12-19 12:19:02 - feat(patient): optimize patient authentication
// Updated: 2025-12-19 12:19:00 - style: fix validation triage system
// Updated: 2025-12-19 12:18:56 - chore(api): improve API endpoints in api
// Updated: 2025-12-19 12:18:53 - style: fix api authentication
// Updated: 2025-12-19 12:18:47 - perf(ui): implement ui dashboard
// Updated: 2025-12-19 12:18:42 - chore(triage): refactor dashboard in triage
// Updated: 2025-12-19 12:18:27 - refactor(validation): improve triage system
// Updated: 2025-12-19 12:18:23 - style(ui): optimize ui authentication (fixes #38)
// Updated: 2025-12-19 12:18:07 - style: refactor triage dashboard
// Updated: 2025-12-19 12:17:55 - docs(api): refactor api dashboard (fixes #21)
// Updated: 2025-12-19 12:17:52 - docs: update auth patient form
// Updated: 2025-12-19 12:07:49 - perf(auth): implement database schema in auth
// Updated: 2025-12-19 12:07:43 - chore(ui): implement error handling
// Updated: 2025-12-19 12:07:41 - chore(api): add api patient form
// Updated: 2025-12-19 12:07:25 - fix: improve triage database schema
// Updated: 2025-12-19 12:07:23 - refactor: fix auth database schema
// Updated: 2025-12-19 12:07:14 - refactor: enhance ui API endpoints
// Updated: 2025-12-19 12:06:56 - chore(database): optimize database error handling
// Updated: 2025-12-19 12:06:46 - test(socket): improve socket error handling
// Updated: 2025-12-19 12:06:30 - chore: add socket UI components
// Updated: 2025-12-19 12:06:29 - feat(patient): add dashboard
// Updated: 2025-12-19 12:06:14 - chore: fix api database schema
// Updated: 2025-12-19 12:06:11 - style(triage): implement triage API endpoints
// Updated: 2025-12-19 12:05:46 - test: fix validation patient form
// Updated: 2025-12-19 12:05:41 - refactor(patient): improve patient form in patient
// Updated: 2025-12-19 12:05:37 - perf(triage): enhance triage database schema
// Updated: 2025-12-19 12:05:34 - style(database): update database database schema
// Updated: 2025-12-19 12:05:32 - style(ui): fix ui dashboard
// Updated: 2025-12-19 12:05:24 - chore(database): refactor database schema in database
// Updated: 2025-12-19 12:05:15 - docs: fix validation dashboard
// Updated: 2025-12-19 12:05:10 - fix: improve database patient form
// Updated: 2025-12-19 12:04:59 - test(patient): improve triage system
// Updated: 2025-12-19 12:04:24 - docs(auth): enhance auth authentication
// Updated: 2025-12-19 12:04:15 - fix: improve database database schema
// Updated: 2025-12-19 12:04:10 - fix(patient): add API endpoints
// Updated: 2025-12-19 12:04:02 - perf(patient): implement patient form
// Updated: 2025-12-19 12:03:57 - test(ui): implement triage system (fixes #32)
// Updated: 2025-12-19 12:03:52 - feat(triage): implement UI components in triage (fixes #41)
// Updated: 2025-12-19 12:03:37 - perf(auth): refactor triage system in auth
import React, { createContext, useState, useContext, useEffect } from 'react';
import * as authService from '../services/authService';

// Create Auth Context
export const AuthContext = createContext();

// AuthProvider component
export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Load user data from localStorage on app start
  useEffect(() => {
    const loadUserFromStorage = () => {
      try {
        console.log('Loading user from storage...');
        const storedToken = authService.getToken();
        const storedUser = localStorage.getItem('user');
        
        if (storedToken && storedUser) {
          console.log('Found stored user and token');
          setToken(storedToken);
          setUser(JSON.parse(storedUser));
          // Set auth header for future requests
          authService.setAuthHeader(storedToken);
        } else {
          console.log('No stored user or token found');
        }
      } catch (error) {
        console.error('Error loading user from localStorage:', error);
        // Clear corrupted data
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      } finally {
        setLoading(false);
      }
    };

    loadUserFromStorage();
  }, []);

  // Register function
  const register = async (userData) => {
    try {
      setLoading(true);
      setError(null);
      
      const result = await authService.register(userData);
      console.log('Register result:', result);
      
      if (result.success) {
        setUser(result.data.user);
        setToken(result.data.token);
        
        // Persist user data in localStorage
        localStorage.setItem('user', JSON.stringify(result.data.user));
        
        // Set auth header for future requests
        authService.setAuthHeader(result.data.token);
        
        return { success: true, message: result.message };
      } else {
        setError(result.message);
        return { success: false, message: result.message, errors: result.errors };
      }
    } catch (error) {
      console.error('Registration error:', error);
      const errorMessage = 'Registration failed. Please try again.';
      setError(errorMessage);
      return { success: false, message: errorMessage };
    } finally {
      setLoading(false);
    }
  };

  // Login function
  const login = async (credentials) => {
    try {
      setLoading(true);
      setError(null);

      const result = await authService.login(credentials);
      console.log('Login result:', result);

      if (result.success) {
        setUser(result.data.user);
        setToken(result.data.token);

        // Persist user data in localStorage
        localStorage.setItem('user', JSON.stringify(result.data.user));

        // Set auth header for future requests
        authService.setAuthHeader(result.data.token);

        return { success: true, message: result.message };
      } else {
        setError(result.message);
        return { success: false, message: result.message, errors: result.errors };
      }
    } catch (error) {
      console.error('Login error:', error);
      const errorMessage = 'Login failed. Please try again.';
      setError(errorMessage);
      return { success: false, message: errorMessage };
    } finally {
      setLoading(false);
    }
  };

  // Logout function
  const logout = () => {
    try {
      console.log('Logging out user');
      // Clear auth service token
      authService.logout();
      
      // Clear context state
      setUser(null);
      setToken(null);
      setError(null);
      
      // Remove user data from localStorage
      localStorage.removeItem('user');
      
      return { success: true, message: 'Logged out successfully' };
    } catch (error) {
      console.error('Error during logout:', error);
      return { success: false, message: 'Logout failed' };
    }
  };

  // Check if user is authenticated
  const isAuthenticated = () => {
    return !!(user && token);
  };

  // Clear error function
  const clearError = () => {
    setError(null);
  };

  // Context value
  const contextValue = {
    // State
    user,
    token,
    loading,
    error,
    
    // Methods
    register,
    login,
    logout,
    isAuthenticated,
    clearError
  };

  return (
    <AuthContext.Provider value={contextValue}>
      {children}
    </AuthContext.Provider>
  );
};

// Custom hook to use Auth Context
export const useAuth = () => {
  const context = useContext(AuthContext);
  
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  
  return context;
};































































































